# Nginx Configuration for Next.js Deployment
# Add these blocks to your nginx server configuration

# =====================================
# Cache Headers for _next/static assets
# =====================================
# Static assets are hashed and immutable - cache forever
location /_next/static/ {
    alias /home/test.heiraza.com/public_html/.next/static/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# =====================================
# Prevent caching of dynamic routes
# =====================================
# Server actions and API routes should not be cached
location ~ ^/(api|_next/data)/ {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    
    # Disable caching for dynamic routes
    add_header Cache-Control "no-store, no-cache, must-revalidate";
    proxy_no_cache 1;
    proxy_cache_bypass 1;
}

# =====================================
# Expose Build ID in Response Headers
# =====================================
# Optional: Read build ID from file and add to responses
# Requires reading .next/BUILD_ID at server start
# 
# Example using lua module (if available):
# set_by_lua $build_id 'return io.open("/home/test.heiraza.com/public_html/.next/BUILD_ID"):read("*a")';
# add_header X-Build-ID $build_id;

# =====================================
# Health Check Endpoint (no cache)
# =====================================
location = /api/health {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    add_header Cache-Control "no-store";
    proxy_no_cache 1;
    proxy_cache_bypass 1;
}

# =====================================
# Main proxy configuration
# =====================================
location / {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}

# =====================================
# Uploads directory (static files)
# =====================================
location /uploads/ {
    alias /home/test.heiraza.com/public_html/public/uploads/;
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# =====================================
# DEPLOYMENT WORKFLOW
# =====================================
# 1. SSH to server
# 2. cd /home/test.heiraza.com/public_html
# 3. git pull origin main
# 4. chmod +x scripts/deploy.sh
# 5. ./scripts/deploy.sh
#
# This ensures:
# - Clean .next build (no stale files)
# - Fresh npm install
# - pm2 restart AFTER build completes
# - Health check verification
